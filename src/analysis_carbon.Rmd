---
title: "Carbon analyses"
author: "Gabe Runte"
date: "2024-01-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(janitor)
library(RColorBrewer)
library(tidyverse)
library(patchwork)
source(here("src", "colors.R"))

```

```{r, message = F}
measure = read_csv(here("data", "analysis/size_master.csv"))
harvest = read_csv(here("data", "analysis/harvest_metrics.csv")) 
health = read_csv(here("data", "analysis/ndvi_data.csv"))
harvest_tips = read_csv(here("data", "analysis/harvest_roottips - all.csv"))
repot_tips = read_csv(here("data", "repotting/ghecto_repotting_root_pulling_data.csv"))
repot_mass = read_csv(here("data", "repotting", "repotting_drymass_fitted.csv"))
harvest_mass = read_csv(here("data", "harvest", "harvest_biomass_wideclean.csv"))
image_data = read_csv(here("data", "wide_final_seedling_area.csv"))
neighb_pairs = read_csv(here("data", "design", "ghecto_neighbor_pairs.csv"))
trt = read_csv(here("data", "design", "seedling_treatments.csv"))
drought = read_csv(here("data", "design", "drought_assignments_bypot.csv")) %>% 
  select(1,3)
harvest_comm = read_csv( here("data", "harvest", "harvest_community_matrix_scaled.csv"))

pressure = read_csv(here("data/harvest", "pressure_bomb - Sheet1.csv")) %>% 
  select(1:4) %>%  mutate(time = tolower(time))
sapwood = read_csv(here("data/harvest", "harvest_sapwood.csv"))
```

```{r}
colonization = repot_tips %>% 
  mutate(repot_col = colonization_numerator/colonization_denominator) %>% 
  select(seedling_id, repot_col) %>% 
  left_join(harvest_tips %>% mutate(harvest_col = colonized/(colonized+uncolonized)) %>% 
              select(seedling_id, harvest_col) %>% 
              mutate(seedling_id = as.numeric(seedling_id)))

drought_treat = health %>% 
  select(seedling_id, treatment) %>% distinct()

total_treat = measure %>% 
  select(seedling_id, seedling_sp, soil_type, neighbor, neighb_sp, neighb_st, pot) %>% distinct() %>% drop_na()

image_df = image_data %>% left_join(total_treat) %>% 
  mutate(total_foliar = foliar+predawn_foliar+midday_foliar) %>% 
  left_join(drought_treat)

sort_string_chars <- function(s) {
  paste(sort(unlist(strsplit(s, ""))), collapse = "")
}

pot_df = neighb_pairs %>% 
  rename(seedling_id = seedling_1) %>% 
  left_join(trt) %>% 
  rename(sp1 = seedling_sp, st1 = soil_type) %>% 
  select(!seedling_id) %>% 
  rename(seedling_id = seedling_2) %>% 
  left_join(trt)%>% 
  rename(sp2 = seedling_sp, st2 = soil_type) %>% 
  mutate(spp = paste0(sp1, sp2))%>% 
  mutate(stt = paste0(st1, st2)) %>% 
  select(pot, spp, stt) %>% 
  mutate(spp = map_chr(spp, sort_string_chars)) %>% #alphabetize the combo to minimize different uniques
  mutate(stt = map_chr(stt, sort_string_chars)) %>% 
  left_join(drought)

masschange = repot_mass %>% 
  rename(r_root = below_dry, r_shoot = above_dry) %>% 
  left_join(harvest_mass %>% 
              mutate(shoot = shoot+foliar) %>% 
              select(-foliar) %>% 
              rename(h_shoot = shoot, h_root = root)) %>% 
  mutate(d_root = h_root/r_root, d_shoot = h_shoot/r_shoot, d_total = (h_root+h_shoot)/(r_root+r_shoot)) %>% 
  left_join(total_treat)%>%
  mutate(nst_long = case_when(
    neighb_st == "P" ~ "Neighbor Bigcone soil",
    neighb_st == "Q" ~ "Neighbor Oak soil",
    neighb_st == "C" ~ "Neighbor Sterile soil"
  ))%>% 
  mutate(nsp_long = case_when(
    neighb_sp == "P" ~ "Neighbor Bigcone",
    neighb_sp == "Q" ~ "Neighbor Oak"
  )) %>% 
  left_join(drought_treat) %>% 
  filter(soil_type != "C") %>% 
  filter(neighb_st != "C") %>% 
  filter(!is.na(h_shoot))

living = measure %>% 
  filter(date == "2022-04-01") %>% 
  filter(alive ==1) %>% 
  filter(neighb_alive == 1) %>% 
  select(seedling_id)
```

```{r}
mx = masschange %>% 
  filter(soil_type != "C") %>% 
  filter(neighb_st != "C") %>% 
  filter(seedling_id %in% living$seedling_id) %>% 
  mutate(d_rs = d_root/d_shoot) %>% 
  left_join(masschange %>% 
              select(seedling_id, d_total, d_root, d_shoot) %>% 
              rename(neighbor = seedling_id, n_total = d_total, n_root = d_root, n_shoot = d_shoot)) %>% 
  mutate(sp_long = case_when(
    seedling_sp == "P" ~ "Bigcone",
    seedling_sp == "Q" ~ "Oak"
  )) %>% 
  left_join(health %>% 
              select(seedling_id, mean_ndvi) %>% 
              group_by(seedling_id) %>% 
              summarize(mean_ndvi = mean(mean_ndvi)))

ggplot(mx%>%  filter(seedling_sp == "P"), 
       aes(x = soil_type, y = d_total, col = treatment, fill = soil_type))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtcolor+gg_soilfill

ggplot(mx%>%  filter(seedling_sp == "P"), 
       aes(x = soil_type, y = d_root, col = treatment, fill = soil_type))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtcolor+gg_soilfill

ggplot(mx%>%  filter(seedling_sp == "P"), 
       aes(x = neighb_sp, y = d_total, fill = neighb_sp))+
  geom_boxplot()+gg_nspfill

hsp = ggplot(mx, aes(x = sp_long, y = d_shoot, fill = neighb_sp))+theme_minimal()+
  geom_boxplot()+gg_nspfill+facet_wrap(~sp_long, scales = "free")+theme(axis.text.x = element_blank())+
  labs(x = "Seedling species", y = "Shoot mass growth (harvest/repotting)")+theme(legend.position = 'none')

hrp = ggplot(mx, aes(x = sp_long, y = d_root, fill = neighb_sp))+theme_minimal()+
  geom_boxplot()+gg_nspfill+facet_wrap(~sp_long, scales = "free")+theme(axis.text.x = element_blank())+
  labs(x = "Seedling species", y = "Root mass growth (harvest/repotting)")+theme(legend.position = 'none')

htp = ggplot(mx, aes(x = sp_long, y = d_total, fill = neighb_sp))+theme_minimal()+
  geom_boxplot()+gg_nspfill+facet_wrap(~sp_long, scales = "free")+theme(axis.text.x = element_blank())+
  labs(x = "Seedling species", y = "Total mass growth (harvest/repotting)")

hrsp = ggplot(mx, aes(x = sp_long, y = d_root/d_shoot, fill = neighb_sp))+theme_minimal()+
  geom_boxplot()+gg_nspfill+facet_wrap(~sp_long, scales = "free")+theme(axis.text.x = element_blank())+
  labs(x = "Seedling species", y = "Roos:Shoot of growth")

hp = hrp+hsp+htp
hp1 = hrp+hsp+hrsp
#ggsave(plot = hp, width = 12, height = 5, here("figures", "harvest_sizeplot.png"))
#ggsave(plot = hp1, width = 12, height = 5, here("figures", "harvest_rs_sizeplot.png"))

mc = MASS::stepAIC(lm(d_total~soil_type*neighb_st*neighb_sp*treatment, data = mx%>%  filter(seedling_sp == "P")))

summary(eval(mc$call))                
```

```{r}
rhsp = ggplot(mx, aes(x = nsp_long, y = h_shoot, fill = soil_type, col = neighb_st))+theme_minimal()+
  geom_boxplot(alpha = 0.8)+gg_soilfill+facet_wrap(~sp_long, scales = "free")+gg_nsoilcolor+
  labs(x = "Seedling species", y = "Shoot mass (g)")#+theme(legend.position = 'none')
rhsp

rhrp = ggplot(mx, aes(x = nsp_long, y = h_root, fill = soil_type, col = neighb_st))+theme_minimal()+
  geom_boxplot(alpha = 0.8)+gg_soilfill+facet_wrap(~sp_long, scales = "free")+gg_nsoilcolor+
  labs(x = "Seedling species", y = "Root mass (g)")#+theme(legend.position = 'none')
rhrp

rhrp = ggplot(mx, aes(x = nsp_long, y = h_root+h_shoot, fill = soil_type, col = neighb_st))+theme_minimal()+
  geom_boxplot(alpha = 0.8)+gg_soilfill+facet_wrap(~sp_long, scales = "free")+gg_nsoilcolor+
  labs(x = "Seedling species", y = "Total mass (g)")
rhrp

rhrsp = ggplot(mx, aes(x = nsp_long, y = h_root/h_shoot, fill = soil_type, col = neighb_st))+theme_minimal()+
  geom_boxplot(alpha = 0.8)+gg_soilfill+facet_wrap(~sp_long, scales = "free")+gg_nsoilcolor+
  labs(x = "Seedling species", y = "Roos:Shoot of growth")
rhrsp

```

```{r}
ggplot(mx, aes(h_root/h_shoot, mean_ndvi/h_root, col = soil_type))+gg_soilcolor+
  geom_point()+facet_grid(treatment~seedling_sp)
```


Now lets look at the sapwood information
```{r}
df2 = sapwood %>% 
  rename(sw = sapwood_diameter) %>% 
  left_join(measure %>% 
              filter(date == "2023-03-01")) %>% 
  filter(!is.na(seedling_sp))

ggplot(df2, aes(x = diameter_mm, y = sw, color = seedling_sp))+
  geom_point()
  
summary(lm(sw~diameter_mm+seedling_sp, data = df2))
```

Leaf area to sapwood area -- 2 ways
```{r}
df3 = image_data %>% 
  mutate(all_foliar = midday_foliar+foliar+predawn_foliar) %>% 
  left_join(drought_treat) %>% 
  left_join(sapwood)%>% 
  left_join(measure %>% 
              filter(date == "2023-03-01")) %>% 
  mutate(dia_area = pi*(diameter_mm/2)^2)%>% 
  mutate(st_long = case_when(
    soil_type == "P" ~ "Bigcone soil",
    soil_type == "Q" ~ "Oak soil",
    soil_type == "C" ~ "Sterile soil"
  ))%>% 
  mutate(sp_long = case_when(
    seedling_sp == "P" ~ "Bigcone",
    seedling_sp == "Q" ~ "Oak"
  ))

ggplot(df3, aes(x= seedling_sp, y = all_foliar/sapwood_diameter, fill = treatment))+
  geom_boxplot()
summary(lm((all_foliar/sapwood_diameter)~treatment+seedling_sp, data = df3))

ggplot(df3, aes(x= sp_long, y = all_foliar/dia_area, fill = treatment))+
  geom_boxplot(alpha = 0.8)+facet_grid(cols = vars(st_long))+gg_droughtfill+theme_minimal()+
  labs(x = "", y = "Leaf area:Sapwood area")

ggplot(df3, aes(x= st_long, y = all_foliar/dia_area, fill = treatment))+
  geom_boxplot(alpha = 0.8)+facet_grid(cols = vars(sp_long), scales = "free")+
  gg_droughtfill+theme_minimal()+
  labs(x = "", y = "Leaf area:Sapwood area")

t.test((all_foliar/dia_area)~soil_type, data = df3 %>% 
         filter(seedling_sp == "P") %>%
         filter(soil_type != "C") %>% 
         filter(treatment == "D"))

summary(lm((all_foliar/dia_area)~treatment+seedling_sp+soil_type, data = df3))


summary(lm((all_foliar/dia_area)~treatment+soil_type+neighb_st, data = df3 %>% 
             filter(seedling_sp == "P")))

summary(lm((all_foliar/dia_area)~treatment+neighb_st, data = df3 %>% 
             filter(seedling_sp == "P") %>% 
             filter(soil_type == "C")))

summary(lm((all_foliar/dia_area)~treatment+soil_type, data = df3 %>% 
             filter(seedling_sp == "Q")))
```

```{r}

ggplot(df3 %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type != "C"), 
       aes(x= st_long, y = all_foliar/dia_area, fill = treatment))+
  geom_boxplot(alpha = 0.8)+facet_grid(cols = vars(neighb_sp), rows = vars(neighb_st), scales = "free")+
  gg_droughtfill+theme_minimal()+
  labs(x = "", y = "Leaf area:Sapwood area")
```


Looking like bigcones had strong responses to drought in leaf area per stem area. More watered plants had more leaves. Soil type also contributed to this ratio with both live soil treatments increasing the LA/SA ratio (oak soil slightly more than bigcone soil).

Oaks saw no effect of drought in this ratio. Differences were only attributatble to the soil type. 


## LMA
Next up, let's look at leaf mass per area

```{r}
df4 = harvest_mass %>%
  rename(foliar_mass = foliar) %>% 
  left_join(image_data) %>% 
  left_join(drought_treat)%>% 
  mutate(all_foliar = midday_foliar+foliar+predawn_foliar) %>% 
  drop_na() %>% 
  filter(all_foliar>0)%>% 
  mutate(st_long = case_when(
    soil_type == "P" ~ "Bigcone soil",
    soil_type == "Q" ~ "Oak soil",
    soil_type == "C" ~ "Sterile soil"
  ))%>% 
  mutate(sp_long = case_when(
    seedling_sp == "P" ~ "Bigcone",
    seedling_sp == "Q" ~ "Oak"
  )) %>% 
  left_join(total_treat) %>% 
  mutate(lma = foliar_mass/all_foliar)



ggplot(df4, aes(x = soil_type, y = foliar_mass/all_foliar, fill = treatment))+
  geom_boxplot(alpha= 0.8)+facet_wrap(~seedling_sp)+gg_soilcolor+gg_droughtfill+theme_minimal()+
  labs(y = "Leaf mass per area", x = "")

lma_model = lm(lma~soil_type*neighb_sp*treatment*neighb_st, data = df4 %>% 
             filter(seedling_sp == "P") )

MASS::stepAIC(lma_model)
summary(lm(formula = lma ~ treatment, data = df4 %>% filter(seedling_sp == 
    "P")))

lma_model = lm(lma~soil_type*neighb_sp*treatment*neighb_st, data = df4 %>% 
             filter(seedling_sp == "Q") )

MASS::stepAIC(lma_model)

summary(lm(formula = lma ~ neighb_sp + treatment + neighb_st + neighb_sp:treatment, 
    data = df4 %>% filter(seedling_sp == "Q")))
```
Leaf mass per area is a significant correlate of drought treatment for both bigcones and oaks. Neither species shows a significant relationship with soil type. 

I think the take-home here is that they both did in-fact adapt to the drought! Woohoo. 


## A quick NDVI plot
```{r}
df5 = health %>% 
  left_join(total_treat)%>% 
  mutate(st_long = case_when(
    soil_type == "P" ~ "Bigcone soil",
    soil_type == "Q" ~ "Oak soil",
    soil_type == "C" ~ "Sterile soil"
  ))%>% 
  mutate(sp_long = case_when(
    seedling_sp == "P" ~ "Bigcone",
    seedling_sp == "Q" ~ "Oak"
  )) %>% 
  drop_na() %>% 
  filter(soil_type != "C") %>% 
  filter(neighb_st != "C")

df.date = df5 %>% 
  select(date_time, sample) %>% 
  mutate(date_time = mdy(date_time)) %>% 
  arrange(date_time) %>% 
  group_by(sample) %>% 
  slice(1) %>% 
  rename(date = date_time)



ggplot(df5, aes(x = as.factor(sample), y = mean_ndvi, fill = soil_type, color = treatment))+
          geom_boxplot()+facet_wrap(~seedling_sp)+gg_soilfill+gg_droughtcolor

ggplot(df5, aes(x = as.factor(sample), y = mean_ndvi, fill = soil_type, color = treatment))+
          geom_boxplot()+facet_grid(rows = vars(sp_long), cols = vars(st_long))+gg_soilfill+gg_droughtcolor+
  labs(x = "Sample timepoint (sequential)", y = "Mean NDVI")+theme_minimal()


ggplot(df5 %>% 
         filter(sample=="4"), aes(x = st_long, y = mean_ndvi, fill = treatment))+
          geom_boxplot(alpha = 0.8)+facet_grid(rows = vars(sp_long))+gg_droughtfill+
  labs(x = "Sample timepoint (sequential)", y = "Mean NDVI")+theme_minimal()

ggplot(df5 %>% 
         group_by(seedling_sp, soil_type, neighb_sp, neighb_st, st_long, sp_long, treatment, seedling_id) %>% 
         summarise(mean_ndvi = mean(mean_ndvi)), aes(x = st_long, y = mean_ndvi, fill = treatment, col = neighb_st))+
          geom_boxplot(alpha = 0.8)+facet_grid(sp_long~neighb_sp)+gg_droughtfill+
  labs(x = "Sample timepoint (sequential)", y = "Mean NDVI")+theme_minimal()+gg_nsoilcolor


ggplot(df5 %>% 
         group_by(seedling_sp, soil_type, neighb_sp, neighb_st, st_long, sp_long, treatment, seedling_id) %>% 
         summarise(mean_ndvi = mean(mean_ndvi)), 
       aes(x = neighb_sp, y = mean_ndvi, fill = treatment, col = neighb_st))+
          geom_boxplot(alpha = 0.8)+facet_grid(sp_long~st_long)+gg_droughtfill+
  labs(x = "", y = "Mean NDVI")+theme_minimal()+gg_nsoilcolor
```


```{r}
dfx = df5 %>% 
         group_by(seedling_sp, soil_type, neighb_sp, neighb_st, st_long, sp_long, treatment, seedling_id) %>% 
         summarise(mean_ndvi = mean(mean_ndvi)) %>% 
  mutate(sp_match = seedling_sp == neighb_sp) %>% 
  mutate(st_match = soil_type ==neighb_st) %>% 
  mutate(all_trt = paste0(seedling_sp, soil_type, neighb_sp, neighb_st)) %>% 
  mutate(nq = str_count(all_trt, "Q"))%>% 
  mutate(np = str_count(all_trt, "P"))%>%
  mutate(nst_long = case_when(
    neighb_st == "P" ~ "Neighbor Bigcone soil",
    neighb_st == "Q" ~ "Neighbor Oak soil",
    neighb_st == "C" ~ "Neighbor Sterile soil"
  ))%>% 
  mutate(nsp_long = case_when(
    neighb_sp == "P" ~ "Neighbor Bigcone",
    neighb_sp == "Q" ~ "Neighbor Oak"
  )) %>% 
  left_join(total_treat) %>% 
  left_join(repot_mass %>%  select(1,4:5) %>% rename(root = below_dry, shoot = above_dry)) %>% 
  left_join(repot_mass %>% select(1,4:5) %>% rename(neighbor = seedling_id, n_root = below_dry, n_shoot = above_dry)) %>% 
  mutate(n_rs = (n_root+n_shoot)/(root+shoot)) %>% 
  left_join(masschange %>% select(1,6:10))%>% 
  left_join(masschange %>% select(1,6:10) %>%  
              rename(neighbor = seedling_id, nd_total = d_total, nd_root = d_root, nd_shoot = d_shoot, nh_root = h_root, nh_shoot = h_shoot)) %>% 
  mutate(n_tot = nh_root+nh_shoot) %>% 
  mutate(spmatch = as.numeric(seedling_sp == neighb_sp))%>% 
  mutate(stmatch = as.numeric(seedling_sp == soil_type))%>% 
  mutate(nstmatch = as.numeric(seedling_sp == neighb_st)) %>% 
  mutate(match =stmatch+nstmatch) %>% # spmatch+
  mutate(soilcombo = paste0(soil_type, neighb_st)) %>% 
  filter(seedling_id %in% living$seedling_id) %>% 
  left_join(colonization)


m = MASS::stepAIC(lm(mean_ndvi~ soil_type*neighb_sp*neighb_st*treatment*nd_total, data = dfx %>%  filter(seedling_sp == "P")))

summary(eval(m$call))

ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = mean_ndvi, fill = neighb_sp))+
  geom_boxplot()+
  facet_grid(~treatment)+gg_nspfill

ggplot(dfx %>%  filter(seedling_sp == "Q"),
       aes(x = soil_type, y = mean_ndvi, fill = treatment))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtfill

ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = mean_ndvi,fill = treatment))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtfill

```

```{r}

m = MASS::stepAIC(lm(d_total~ soil_type*neighb_sp*neighb_st*treatment, data = masschange %>%  filter(seedling_sp == "Q")))

summary(eval(m$call))
```


```{r}

dfxs = dfx  %>% 
  group_by(seedling_sp, soil_type, neighb_sp, neighb_st, treatment) %>% 
  summarize(mean_ndvi = mean(mean_ndvi)) %>% 
  pivot_wider(names_from = treatment, values_from = mean_ndvi) %>% 
  mutate(mean_ndvi = D-C)

ggplot(dfxs %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = mean_ndvi, col = mean_ndvi))+geom_point(size = 2)+
  facet_grid(neighb_sp~neighb_st)+geom_hline(yintercept = 0)


m = MASS::stepAIC(lm(mean_ndvi~ soil_type*neighb_sp*neighb_st*treatment*nh_root, data = dfx %>%  filter(seedling_sp == "P")))

summary(eval(m$call))

ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = mean_ndvi, fill = neighb_sp))+
  geom_boxplot()+
  facet_grid(~treatment)+gg_nspfill

ggplot(dfx %>%  filter(seedling_sp == "Q"),
       aes(x = soil_type, y = mean_ndvi, fill = treatment))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtfill

ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = mean_ndvi,fill = treatment))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtfill

ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = mean_ndvi,col = treatment, fill = match))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtcolor


ggplot(dfx %>%  filter(seedling_sp == "Q"),
       aes(x = soil_type, y = mean_ndvi,col = treatment, fill = match))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtcolor

ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = soil_type, y = h_root+h_shoot,col = treatment, fill = match))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtcolor

ggplot(dfx %>%  filter(seedling_sp == "Q"),
       aes(x = soil_type, y = h_root+h_shoot,col = treatment, fill = match))+
  geom_boxplot()+
  facet_grid(nsp_long~nst_long)+gg_droughtcolor

# mx = MASS::stepAIC(lm(mean_ndvi~ treatment*match*soil_type*neighb_sp*neighb_st, 
#                       data = dfx%>%  filter(seedling_sp == "P")))
# 
# mx = MASS::stepAIC(lm((h_shoot+h_root)~ treatment*match*soil_type*neighb_sp*neighb_st, 
#                       data = dfx%>%  filter(seedling_sp == "Q")))
# 
# summary(eval(mx$call))
```

```{r}
ggplot(dfx %>%  filter(seedling_sp == "P"),
       aes(x = as.factor(match), y = mean_ndvi, fill = treatment))+
  geom_boxplot()+geom_smooth(method = "lm", se = F)+gg_droughtfill+facet_wrap(~nsp_long, scales = "free")+labs(x = "Number of home soils", y = "Mean NDVI", title = "Bigcone")+theme_minimal()

ggplot(dfx %>%  filter(seedling_sp == "Q"),
       aes(x = as.factor(match), y = mean_ndvi, fill = treatment))+
  geom_boxplot()+geom_smooth(method = "lm", se = F)+gg_droughtfill+facet_wrap(~nsp_long, scales = "free")+labs(x = "Number of home soils", y = "Mean NDVI", title = "Oaks")+theme_minimal()

summary(lm(mean_ndvi~treatment*match, data  =dfx %>%  filter(seedling_sp == "P")))
```




```{r}
ggplot(harvest_mass %>% left_join(total_treat)%>% left_join(drought_treat) %>% filter(seedling_sp == "Q"), 
       aes(x = soil_type, y = (shoot+root+foliar), fill = treatment))+
         facet_grid(neighb_st~neighb_sp)+geom_boxplot()

ggplot(harvest_mass %>% left_join(total_treat)%>% left_join(drought_treat) %>% filter(seedling_sp == "Q") %>% 
         filter(soil_type != "C") %>% filter(neighb_st != "C"),
       aes(x = soil_type, y = (shoot+root+foliar), fill = treatment))+geom_boxplot()+facet_grid(neighb_st~neighb_sp)
ggplot(harvest_mass %>% left_join(total_treat)%>% left_join(drought_treat) %>% filter(seedling_sp == "P") %>% 
         filter(soil_type != "C") %>% filter(neighb_st != "C"),
       aes(x = soil_type, y = (shoot+root+foliar), fill = treatment))+geom_boxplot()+facet_grid(neighb_st~neighb_sp)
```


```{r}
dflog = df5 %>%
  filter(seedling_id %in% living$seedling_id) %>% 
  filter(soil_type != "C") %>% 
  filter(neighb_st != "C") %>% 
  group_by(seedling_sp, soil_type, neighb_sp, neighb_st, treatment, sample) %>% 
  summarise(
    ndvi = mean(log(mean_ndvi), na.rm = TRUE))

dflogvar = df5 %>% 
  left_join(dflog%>%
  rename( meanlog= ndvi)) %>% 
  mutate(var = (log(mean_ndvi)-meanlog)^2) %>%
  filter(!is.na(var)) %>% 
  group_by(seedling_sp, soil_type, neighb_sp, neighb_st, treatment, sample) %>% 
  summarise(
    meanvar = sum(var)/(n()-1)) %>% 
  left_join(dflog)%>% 
  rename(ndvi_sd = meanvar) %>% 
  pivot_wider(names_from = treatment, values_from = c(ndvi, ndvi_sd)) %>% 
  mutate(log_rat = ndvi_D-ndvi_C) %>% 
  mutate(log_sd = ndvi_sd_D+ndvi_C )%>% 
  left_join(df.date)%>% 
  mutate(neighbst_long = case_when(
    neighb_st == "P" ~ "Bigcone soil neighbor",
    neighb_st == "Q" ~ "Oak soil neighbor",
    neighb_st == "C" ~ "Sterile soil neighbor"
  ))%>% 
  mutate(neighbsp_long = case_when(
    neighb_sp == "P" ~ "Bigcone neighbor",
    neighb_sp == "Q" ~ "Oak neighbor"
  ))
```


```{r}

ggplot(dflogvar %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "P"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 3)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Bigcone Soil")

ggplot(dflogvar %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "Q"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 3)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Oak Soil")

ggplot(dflogvar %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "C"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 3)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Sterile Soil")

ggplot(dflogvar %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "P"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Bigcone Soil")

ggplot(dflogvar %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "Q"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 3)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Oak Soil")

ggplot(dflogvar %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "C") %>% 
         filter(neighb_sp =="Q"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 3)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Sterile Soil")
```

```{r}
dflog_harvest = dflogvar %>% 
  filter(sample==4) 


ggplot(dflog_harvest %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "P"), aes(x = neighbst_long, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 6)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=.25)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Bigcone Soil")

ggplot(dflog_harvest %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "Q"), aes(x = neighbst_long, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 6)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=.25)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Oak Soil")

# ggplot(dflog_harvest %>% 
#          filter(seedling_sp == "P") %>% 
#          filter(soil_type == "C"), aes(x = neighbst_long, y = log_rat, color = neighb_st))+
#   geom_line()+
#   geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
#   geom_point( size = 6)+
#   geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=.25)+
#   facet_grid(rows = vars(neighbsp_long), scales = "free")+
#   gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Sterile Soil")

ggplot(dflog_harvest %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "P"), aes(x = neighbst_long, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point(size = 6)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=.25)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Bigcone Soil")

ggplot(dflog_harvest %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "Q"), aes(x = neighbst_long, y = log_rat, color = neighb_st))+
  geom_line()+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point( size = 6)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=.25)+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Oak Soil")

# ggplot(dflog_harvest %>% 
#          filter(seedling_sp == "Q") %>% 
#          filter(soil_type == "C") %>% 
#          filter(neighb_sp =="Q"), aes(x = neighbst_long, y = log_rat, color = neighb_st))+
#   geom_line()+
#   geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
#   geom_point( size = 6)+
#   geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=.25)+
#   facet_grid(rows = vars(neighbsp_long), scales = "free")+
#   gg_soilcolor+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Sterile Soil")
```

```{r}
test = df5 %>% 
  mutate(neighbst_long = case_when(
    neighb_st == "P" ~ "Bigcone soil neighbor",
    neighb_st == "Q" ~ "Oak soil neighbor",
    neighb_st == "C" ~ "Sterile soil neighbor"
  ))%>% 
  mutate(neighbsp_long = case_when(
    neighb_sp == "P" ~ "Bigcone neighbor",
    neighb_sp == "Q" ~ "Oak neighbor"
  ))%>% 
  filter(sample == 4) %>%
  filter(seedling_sp == "P") %>%
  filter(soil_type == "Q")

#TukeyHSD(aov(mean_ndvi~(treatment*neighb_sp)+ (treatment*neighb_st), data = test))
TukeyHSD(aov(mean_ndvi~(treatment*neighb_st), data = test))


ggplot(test, aes(x = neighb_st, y = mean_ndvi, fill = neighb_st))+
  geom_boxplot(alpha = 0.8, aes(color = treatment))+
  facet_grid(cols = vars(neighbsp_long))+
  gg_soilfill+labs(x = "Neighbor species soil", y="Mean NDVI", title = "Bigcones from sterile Soil")

```


Dropping control soil seedlings (all) to do analyses across neighb_spp
```{r}
df5.log = df5 %>%
  group_by(seedling_sp, soil_type, neighb_sp, neighb_st, treatment, sample) %>% 
  summarise(
    ndvi = mean(mean_ndvi),
    ndvi_sd = sd(mean_ndvi)
  ) %>% 
  pivot_wider(names_from = treatment, values_from = c(ndvi, ndvi_sd)) %>% 
  mutate(log_rat = log(ndvi_D/ndvi_C)) %>% 
  mutate(log_sd = sqrt( ((ndvi_sd_D)^2/ndvi_D^2)+((ndvi_sd_C)^2/ndvi_C^2)) ) %>% 
  left_join(df.date)%>% 
  mutate(neighbst_long = case_when(
    neighb_st == "P" ~ "Bigcone soil neighbor",
    neighb_st == "Q" ~ "Oak soil neighbor",
    neighb_st == "C" ~ "Sterile soil neighbor"
  ))%>% 
  mutate(neighbsp_long = case_when(
    neighb_sp == "P" ~ "Bigcone neighbor",
    neighb_sp == "Q" ~ "Oak neighbor"
  )) %>% 
  filter(neighb_st != "C")


ggplot(df5.log %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "P"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point(position=position_dodge(width=15), size = 4)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5, position=position_dodge(width=15))+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+theme_minimal()+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Bigcone Soil")

ggplot(df5.log %>% 
         filter(seedling_sp == "P") %>% 
         filter(soil_type == "Q"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point(position=position_dodge(width=15), size = 4)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5, position=position_dodge(width=15))+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+theme_minimal()+labs(x = "Date", y="log(Drought:Watered)", title = "Bigcones from Oak Soil")

ggplot(df5.log %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "P"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point(position=position_dodge(width=15), size = 4)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5, position=position_dodge(width=15))+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+theme_minimal()+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Bigcone Soil")

ggplot(df5.log %>% 
         filter(seedling_sp == "Q") %>% 
         filter(soil_type == "Q"), aes(x = date, y = log_rat, color = neighb_st))+
  geom_hline(yintercept=0, linetype="dashed", color = "red", size=.5)+
  geom_point(position=position_dodge(width=15), size = 4)+
  geom_errorbar(aes(ymin=log_rat-log_sd, ymax=log_rat+log_sd), width=5, position=position_dodge(width=15))+
  facet_grid(rows = vars(neighbsp_long), scales = "free")+
  gg_soilcolor+theme_minimal()+labs(x = "Date", y="log(Drought:Watered)", title = "Oaks from Oak Soil")

```



```{r}
df = df5 %>% 
  filter(seedling_sp == "Q")%>% 
  filter(soil_type == "Q")

ggplot(df, aes(x = as.factor(sample),y = mean_ndvi, fill = treatment))+
  geom_boxplot()+facet_grid(cols = vars(neighb_st), rows = vars(neighb_sp))+
  gg_droughtfill+theme_minimal()+labs(x = "Timepoint", y = "NDVI", title = "QXQ")+theme(legend.position = "none")

df = df5 %>% 
  filter(seedling_sp == "Q")%>% 
  filter(soil_type == "P")

ggplot(df, aes(x = as.factor(sample),y = mean_ndvi, fill = treatment))+
  geom_boxplot()+facet_grid(cols = vars(neighb_st), rows = vars(neighb_sp))+
  gg_droughtfill+theme_minimal()+labs(x = "Timepoint", y = "NDVI", title = "QxP")+theme(legend.position = "none")

df = df5 %>% 
  filter(seedling_sp == "Q")%>% 
  filter(soil_type == "C") %>% 
  filter(neighb_sp == "Q")

ggplot(df, aes(x = as.factor(sample),y = mean_ndvi, fill = treatment))+
  geom_boxplot()+facet_grid(cols = vars(neighb_st), rows = vars(neighb_sp))+
  gg_droughtfill+theme_minimal()+labs(x = "Timepoint", y = "NDVI", title = "QxC")+theme(legend.position = "none")
```


HEalth trade-off of having high RS-ratio
```{r}
health
harvest_mass


h_mean = health %>% 
  group_by(seedling_id) %>% 
  summarize(
    ndvi = mean(mean_ndvi)
  )
trd = harvest_mass %>% 
  left_join(h_mean) %>% 
  left_join(total_treat) %>% 
  left_join(drought_treat) %>% 
  mutate(rs = root/(shoot+foliar))%>% 
  mutate(rf = root/foliar) %>% 
  filter(! is.na(seedling_sp))


ggplot(trd %>% 
         filter(rf<100), aes(x = ndvi^2, y = rf, col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(rows = vars(seedling_sp), cols = vars(treatment))+gg_soilcolor+geom_smooth(method = "lm", se = F)

ggplot(trd, aes(y = ndvi, x = root, col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(cols = vars(seedling_sp), rows = vars(treatment), scales = "free")+
  gg_soilcolor+geom_smooth(method = "gam", se = F)

ggplot(trd, aes(y = ndvi, x = shoot, col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(cols = vars(seedling_sp), rows = vars(treatment), scales = "free")+
  gg_soilcolor+geom_smooth(method = "gam", se = F)

ggplot(trd, aes(y = ndvi, x = foliar, col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(cols = vars(seedling_sp), rows = vars(treatment), scales = "free")+
  gg_soilcolor+geom_smooth(method = "gam", se = F)

ggplot(trd, aes(y = ndvi, x = (shoot+foliar), col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(cols = vars(seedling_sp), rows = vars(treatment), scales = "free")+
  gg_soilcolor+geom_smooth(method = "gam", se = F)

ggplot(trd, aes(y = ndvi, x = (root+shoot+foliar), col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(cols = vars(seedling_sp), rows = vars(treatment), scales = "free")+
  gg_soilcolor+geom_smooth(method = "gam", se = F)

ggplot(trd, aes(y = ndvi/(root+shoot+foliar), x = (root+shoot+foliar), col = soil_type, shape = treatment))+ 
  geom_point()+facet_grid(cols = vars(seedling_sp), rows = vars(treatment), scales = "free")+
  gg_soilcolor+geom_smooth(method = "lm", se = F)
```













