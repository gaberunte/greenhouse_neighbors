---
title: "analysis 2"
author: "Gabe Runte"
date: "2024-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(janitor)
library(RColorBrewer)
library(tidyverse)

gg_soilcolor = scale_color_manual(name = "Soil condition", breaks = c("P", "Q", "C"), labels = c("Bigcone", "Oak", "Control"),
                                  values = c("#2A0944", "#3FA796", "#FEC260"))
```


I begin by reading in the relevant data.
```{r, message = F}
measure = read_csv(here("data", "analysis/size_master.csv"))
harvest = read_csv(here("data", "analysis/harvest_metrics.csv")) 
health = read_csv(here("data", "analysis/ndvi_data.csv"))
harvest_tips = read_csv(here("data", "analysis/harvest_roottips - all.csv"))
harvest_mass = read_csv(here("data", "harvest", "harvest_biomass_wideclean.csv"))
repot_tips = read_csv(here("data", "repotting/ghecto_repotting_root_pulling_data.csv"))
image_data = read_csv(here("data", "wide_final_seedling_area.csv"))
neighb_pairs = read_csv(here("data", "design", "ghecto_neighbor_pairs.csv"))
trt = read_csv(here("data", "design", "seedling_treatments.csv"))
drought = read_csv(here("data", "design", "drought_assignments_bypot.csv")) %>% 
  dplyr::select(1,3)

repot_comm = read_csv(here("data", "repotting", "repot_community_matrix_scaled.csv")) 
harvest_comm = read_csv( here("data", "harvest", "harvest_community_matrix_scaled.csv"))

repot_scan = read_csv(here("data/repotting", "seedling_scan_data.csv")) %>% 
  select(-seedling_sp, -notes)
```

```{r}
colonization = repot_tips %>% 
  mutate(repot_col = colonization_numerator/colonization_denominator) %>% 
  select(seedling_id, repot_col) %>% 
  left_join(harvest_tips %>% mutate(harvest_col = colonized/(colonized+uncolonized)) %>% 
              select(seedling_id, harvest_col) %>% 
              mutate(seedling_id = as.numeric(seedling_id)))

drought_treat = health %>% 
  select(seedling_id, treatment) %>% distinct()

total_treat = measure %>% 
  select(seedling_id, seedling_sp, soil_type, neighbor, neighb_sp, neighb_st, pot) %>% distinct() %>% drop_na()

image_df = image_data %>% left_join(total_treat) %>% 
  mutate(total_foliar = foliar+predawn_foliar+midday_foliar) %>% 
  left_join(drought_treat)

sort_string_chars <- function(s) {
  paste(sort(unlist(strsplit(s, ""))), collapse = "")
}

pot_df = neighb_pairs %>% 
  rename(seedling_id = seedling_1) %>% 
  left_join(trt) %>% 
  rename(sp1 = seedling_sp, st1 = soil_type) %>% 
  select(!seedling_id) %>% 
  rename(seedling_id = seedling_2) %>% 
  left_join(trt)%>% 
  rename(sp2 = seedling_sp, st2 = soil_type) %>% 
  mutate(spp = paste0(sp1, sp2))%>% 
  mutate(stt = paste0(st1, st2)) %>% 
  select(pot, spp, stt) %>% 
  mutate(spp = map_chr(spp, sort_string_chars)) %>% #alphabetize the combo to minimize different uniques
  mutate(stt = map_chr(stt, sort_string_chars)) %>% 
  left_join(drought)
```

```{r}
df1a = repot_scan %>% 
  rename(above = above_area_cm2, below = underground_area_cm2) %>% 
  mutate(total_size = above+below) %>% 
  mutate(abovebelow = above/below) %>% 
  left_join(total_treat) %>% 
  filter(!is.na(seedling_sp)) %>% 
  group_by(seedling_sp) %>% 
  mutate(total_size = (total_size-mean(total_size))/sd(total_size)) %>% 
  mutate(abovebelow = (abovebelow-mean(abovebelow))/sd(abovebelow)) 

ggplot(df1a, aes(x = seedling_sp, y = total_size, fill = soil_type))+
  geom_boxplot()

ggplot(df1a, aes(x = seedling_sp, y = abovebelow, fill = soil_type))+
  geom_boxplot()


df1b = image_data %>% 
  rename(above = all_above, below = belowground) %>% 
  mutate(total_size = above+below) %>% 
  mutate(abovebelow = above/below)  %>% 
  filter(above>0, below>0) %>% 
  group_by(seedling_sp) %>% 
  mutate(total_size = (total_size-mean(total_size))/sd(total_size)) %>% 
  mutate(abovebelow = (abovebelow-mean(abovebelow))/sd(abovebelow)) 

ggplot(df1b, aes(x = seedling_sp, y = total_size, fill = soil_type))+
  geom_boxplot()

ggplot(df1b, aes(x = seedling_sp, y = abovebelow, fill = soil_type))+
  geom_boxplot()



df1 = df1a %>% 
  select(seedling_id, abovebelow, total_size) %>% 
  rename(ab_repot = abovebelow, tot_repot = total_size) %>% 
  left_join(df1b %>%  select(seedling_id, abovebelow, total_size)%>% 
  rename(ab_harvest = abovebelow, tot_harvest = total_size)) %>% 
  mutate(ab_change = ab_harvest-ab_repot, tot_change = tot_harvest-tot_repot) %>% 
  left_join(total_treat) %>% 
  left_join(drought_treat) %>% 
  filter(!is.na(treatment))


ggplot(df1 %>% filter(seedling_sp== "P"),
       aes(x = neighb_st, y = tot_change, fill = neighb_sp))+geom_boxplot()+
  facet_grid(cols = vars(soil_type), rows = vars(treatment))

ggplot(df1 %>% filter(seedling_sp== "Q"),
       aes(x = neighb_st, y = tot_change, fill = neighb_sp))+geom_boxplot()+
  facet_grid(cols = vars(soil_type), rows = vars(treatment))

ggplot(df1 %>% filter(seedling_sp== "P"),
       aes(x = neighb_st, y = ab_change, fill = neighb_sp))+geom_boxplot()+
  facet_grid(cols = vars(soil_type), rows = vars(treatment))

ggplot(df1 %>% filter(seedling_sp== "Q"),
       aes(x = neighb_st, y = ab_change, fill = neighb_sp))+geom_boxplot()+
  facet_grid(cols = vars(soil_type), rows = vars(treatment))
```

```{r}
ggplot(image_data %>% 
         left_join(total_treat) %>% left_join(drought_treat), aes(x = treatment, y = total_size, fill = soil_type))+
  facet_wrap(~ seedling_sp)+geom_boxplot()
```



```{r, message = F}

df2 = image_data %>% 
  left_join(total_treat) %>% 
  filter(seedling_sp == "Q") %>% 
  filter(soil_type == "Q") %>% 
  left_join(drought_treat) %>% 
  filter(neighb_st == "Q")

ggplot(df2, aes(x = neighb_sp, y = total_size, fill =neighb_sp))+
  geom_boxplot()+facet_wrap(~treatment)

ggplot(df2, aes(x = neighb_sp, y = ab_ratio, fill =neighb_sp))+
  geom_boxplot()+facet_wrap(~treatment)

# t.test(ab_ratio~neighb_sp, data = df2 %>% filter(treatment == "C"))
# t.test(ab_ratio~neighb_sp, data = df2 %>% filter(treatment == "D"))

ggplot(df2, aes(x = neighb_sp, y = foliar, fill =neighb_sp))+
  geom_boxplot()+facet_wrap(~treatment)

ggplot(df2, aes(x = neighb_sp, y = aboveground, fill =neighb_sp))+
  geom_boxplot()+facet_wrap(~treatment)

ggplot(df2, aes(x = neighb_sp, y = belowground, fill =neighb_sp))+
  geom_boxplot()+facet_wrap(~treatment)

#t.test(foliar~neighb_sp, data = df2 %>% filter(treatment == "D"))
```

```{r}
summary(lm(total_size ~ seedling_sp*soil_type*neighb_sp*neighb_st+treatment, data = image_data %>% 
  left_join(total_treat) %>% 
  left_join(drought_treat)))

```


Do colonization rates change based on who you are potted next to? 
```{r}
df3 = harvest_tips %>% 
  mutate(colonization = colonized/(colonized+uncolonized)) %>% 
  mutate(seedling_id = as.numeric(seedling_id)) %>% 
  left_join(total_treat)



ggplot(df3 %>% filter(seedling_sp == "P", soil_type == "P"), 
       aes(x = neighb_sp, y = colonization, fill= neighb_st))+geom_boxplot()

ggplot(df3 %>% filter(seedling_sp == "P", soil_type == "Q"), 
       aes(x = neighb_sp, y = colonization, fill= neighb_st))+geom_boxplot()

ggplot(df3 %>% filter(seedling_sp == "Q", soil_type == "P"), 
       aes(x = neighb_sp, y = colonization, fill= neighb_st))+geom_boxplot()

ggplot(df3 %>% filter(seedling_sp == "Q", soil_type == "Q"), 
       aes(x = neighb_sp, y = colonization, fill= neighb_st))+geom_boxplot()
```


```{r}
df4 = health %>% 
  filter(sample == "4") %>% 
  left_join(total_treat) %>% 
  mutate(st = paste0(soil_type, neighb_st)) %>% 
  mutate(soil1 = case_when(
    st %in% c("CC", "CP", "PC", "CQ", "QC")~ "C",
    st %in% c("PP", "PQ", "QP")~ "P",
    st == "QQ" ~ "Q"
  ))%>% 
  mutate(soil2 = case_when(
    st == "CC"~ "C",
    st %in% c("CP", "PC", "PP")~ "P",
    st %in% c("CQ", "QC", "PQ", "QP", "QQ") ~ "Q"
  )) %>% 
  filter(!is.na(soil1), !is.na(soil2))
  

ggplot(df4 %>% filter(seedling_sp == "P"), aes(x = neighb_sp, y = mean_ndvi, fill = treatment))+
  geom_boxplot()+facet_grid(rows = vars(soil1), cols = vars(soil2))

ggplot(df4 %>% filter(seedling_sp == "Q"), aes(x = neighb_sp, y = mean_ndvi, fill = treatment))+
  geom_boxplot()+facet_grid(rows = vars(soil1), cols = vars(soil2))
```

```{r}
df5 = health %>% 
  group_by(seedling_id) %>% 
  mutate(ndvi = mean(mean_ndvi)) %>% 
  left_join(total_treat) %>% 
  drop_na()


ggplot(df5, aes(x = seedling_sp, y = ndvi, fill = soil_type))+
  geom_boxplot()+facet_wrap(~treatment)

ggplot(health %>% left_join(total_treat) %>% drop_na(), 
       aes(x = seedling_sp, y = mean_ndvi, fill = soil_type))+
  geom_boxplot()+facet_grid(rows = vars(treatment), cols = vars(as.factor(sample)))
```


How do size and NDVI relate to one another? If drought stress or competitive outcomes are a result primarily of plant size, we should expect average health to decline with plant size...
```{r}
df6 = health %>% 
  left_join(total_treat) %>% 
  filter(sample == 4) %>% 
  group_by(seedling_sp) %>% 
  drop_na() %>% 
  mutate(ndvi = (mean_ndvi -mean(mean_ndvi))/sd(mean_ndvi)) %>% 
  ungroup() %>% 
  group_by(pot) %>% 
  summarise(ndvi = mean(ndvi))%>% 
  left_join(pot_df)

df7 = harvest_mass %>% 
  mutate(total = shoot+root+foliar) %>% 
  left_join(total_treat)%>% 
  group_by(seedling_sp) %>% 
  drop_na() %>% 
  mutate(mass = (total -mean(total))/sd(total)) %>% 
  ungroup() %>% 
  group_by(pot) %>% 
  summarise(mass = mean(mass)) %>% 
  left_join(drought)

df67 = df6 %>% 
  left_join(df7) %>% 
  mutate(sppd = paste0(spp, "_", drought))

ggplot(df67, aes(x = mass, y = ndvi, color = spp, shape = drought))+
  geom_point()+geom_smooth(method = "lm")

ggplot(df67, aes(x = mass, y = ndvi, color = sppd))+
  geom_point()+geom_smooth(method = "lm", se = F)


ggplot(df67 %>% filter(drought == "Yes"), aes(x = mass, y = ndvi, color = spp))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")

ggplot(df67 %>% filter(drought == "No"), aes(x = mass, y = ndvi, color = spp))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")


ggplot(df67, aes(x = drought, y = ndvi, fill = spp))+
  geom_boxplot()+facet_wrap(~stt)

ggplot(df67, aes(x = drought, y = mass, fill = spp))+
  geom_boxplot()+facet_wrap(~stt)


ggplot(health %>% 
         filter(sample=="4") %>% 
         left_join(harvest_mass) %>% 
         mutate(mass = root+shoot+foliar) %>% 
         filter(!is.na(seedling_sp)), aes(x = mass, y = mean_ndvi, color = treatment))+
  geom_point()+
  geom_smooth(method = "lm", se = F)+
  facet_grid(rows = vars(seedling_sp), cols = vars(soil_type), scales = "free")

ggplot(health %>% 
         filter(sample=="4") %>% 
         left_join(harvest_mass) %>% 
         mutate(mass = root+shoot+foliar) %>% 
         filter(!is.na(seedling_sp)) %>% 
         filter(seedling_sp == "P"), aes(x = mass, y = mean_ndvi, color = treatment))+
  geom_point()+
  geom_smooth(method = "lm", se = F)+
  facet_grid(rows = vars(seedling_sp), cols = vars(soil_type))

ggplot(health %>% 
         filter(sample=="4") %>% 
         left_join(harvest_mass) %>% 
         mutate(mass = root+shoot+foliar) %>% 
         filter(!is.na(seedling_sp)) %>% 
         filter(seedling_sp == "Q"), aes(x = mass, y = mean_ndvi, color = treatment))+
  geom_point()+
  geom_smooth(method = "lm", se = F)+
  facet_grid(rows = vars(seedling_sp), cols = vars(soil_type))
```

#Does richness into the pot predict any stress outcome? 
```{r}
potrich = repot_comm %>% 
  left_join(total_treat) %>% 
  left_join(drought_treat) %>% 
  group_by(pot) %>% 
  summarize(pot_rich = sum(richness))


ndvi_scaled = health %>% 
  select(seedling_id, mean_ndvi, seedling_sp) %>% 
  drop_na() %>% 
  group_by(seedling_sp) %>% 
  mutate(ndvi = (mean_ndvi-mean(mean_ndvi))/sd(mean_ndvi)) %>% 
  group_by(seedling_id) %>% 
  summarize(ndvi = mean(ndvi))

df_rich = ndvi_scaled %>% 
  left_join(total_treat) %>% 
  left_join(drought_treat) %>% 
  left_join(potrich) %>% 
  filter(!is.na(seedling_sp))


ggplot(df_rich, aes(x = pot_rich, y = ndvi, color = soil_type))+
  geom_point()+facet_wrap(~seedling_sp)+geom_smooth(method = "lm", se = F)
```







```{r}
df6 = health %>% 
  left_join(total_treat) %>% 
  filter(sample == 4) %>% 
  group_by(seedling_sp) %>% 
  drop_na() %>% 
  mutate(ndvi = (mean_ndvi -mean(mean_ndvi))/sd(mean_ndvi)) %>% 
  ungroup() %>% 
  left_join(pot_df)

df7 = harvest_mass %>% 
  mutate(total = shoot+root+foliar) %>% 
  left_join(total_treat)%>% 
  group_by(seedling_sp) %>% 
  drop_na() %>% 
  mutate(mass = (total -mean(total))/sd(total)) %>% 
  ungroup() 

df67 = df6 %>% 
  left_join(df7) %>% 
  filter(seedling_sp == "Q")


ggplot(df67 %>% filter(drought == "Yes"), aes(x = mass, y = ndvi, color = spp, shape = soil_type))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")

ggplot(df67 %>% filter(drought == "No"), aes(x = mass, y = ndvi, color = spp, shape = soil_type))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")

df67 = df6 %>% 
  left_join(df7) %>% 
  filter(seedling_sp == "P")


ggplot(df67 %>% filter(drought == "Yes"), aes(x = mass, y = ndvi, color = spp, shape = soil_type))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")

ggplot(df67 %>% filter(drought == "No"), aes(x = mass, y = ndvi, color = spp, shape = soil_type))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")
```

If you are relatively small and your neighbor is relatively large, do you do better or worse? 

```{r}
df8 = df7 %>% 
  select(seedling_id, mass, neighbor) %>% 
  left_join(df7 %>% 
  select(seedling_id, mass) %>% rename(neighbor = seedling_id, neighbor_mass = mass) ) %>% 
  mutate(mass_diff = mass-neighbor_mass) %>% left_join(total_treat) %>% left_join(df6) %>% 
  drop_na()

ggplot(df8, aes(mass_diff, y = ndvi, color = treatment, shape = seedling_sp))+
  geom_point()+facet_wrap(~stt)+geom_smooth(method = "lm")
```


```{r}
df8.plot = df8 %>% 
  filter(seedling_sp == "P") %>% 
  filter(neighb_sp == "Q") %>% 
  filter(!neighb_st == "C")

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+facet_grid(rows = vars(soil_type), cols = vars(neighb_st))+geom_smooth(method = "lm")

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+geom_smooth(method = "lm")

df8.plot = df8 %>% 
  filter(seedling_sp == "P") %>% 
  filter(neighb_sp == "P") 

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+facet_grid(rows = vars(soil_type), cols = vars(neighb_st))+geom_smooth(method = "lm")

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+geom_smooth(method = "lm")


###OAKS###
df8.plot = df8 %>% 
  filter(seedling_sp == "Q") %>% 
  filter(neighb_sp == "Q") 

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+facet_grid(rows = vars(soil_type), cols = vars(neighb_st))+geom_smooth(method = "lm")

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+geom_smooth(method = "lm")

df8.plot = df8 %>% 
  filter(seedling_sp == "Q") %>% 
  filter(neighb_sp == "P") 

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+facet_grid(rows = vars(soil_type), cols = vars(neighb_st))+geom_smooth(method = "lm")

ggplot(df8.plot, aes(x = mass_diff, y = ndvi, color = treatment))+
  geom_point()+geom_smooth(method = "lm")


```


```{r}
df10 = harvest_mass %>% 
  mutate(total = root+shoot+foliar) %>% 
  left_join(total_treat) %>% left_join(drought_treat)


ggplot(df10 %>% filter(seedling_sp == "P"), aes(x = treatment, y = total, fill = neighb_sp))+
  geom_boxplot()+facet_wrap(~soil_type)
ggplot(df10 %>% filter(seedling_sp == "Q"), aes(x = treatment, y = total, fill = neighb_sp))+
  geom_boxplot()+facet_wrap(~soil_type)
```







