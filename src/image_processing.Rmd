---
title: "image processing"
author: "Gabe Runte"
date: "2023-05-16"
output: html_document
---

```{r setup, include=FALSE, messgage = F}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(janitor)
library(magick)
library(tidyverse)
```


## Writing functions

```{r}
# Function to Convert Image to Black and White and Count Black Pixels
bw_conversion_and_count <- function(image_path) {
  # Reading the Image
  img <- image_read(image_path)
  # Changing the levels in the image to increase contrast
  img_mod = img %>% image_modulate( brightness = 150, saturation = 175, hue = 150)
  # Converting the Image to Grayscale
  img_gray <- img_mod %>% image_convert(colorspace = "gray")
  # Converting the Image to Black and White
  img_bw <- img_gray %>% image_threshold("black", "50%")
  # Extracting Image Data
  img_data <- image_data(img_bw)
  # Counting Black Pixels
  black_pixels <- sum(img_data <= 1)  # You can adjust this threshold as necessary
  return(black_pixels)
}

bw_conversion <- function(img, files, path.out) {
  # Changing the levels in the image to increase contrast
  img_mod = img %>% image_modulate( brightness = 175)#, saturation = 175, hue = 150)
  # Converting the Image to Grayscale
  img_gray <- img_mod %>% image_convert(colorspace = "gray")
  # Converting the Image to Black and White
  img_bw <- img_gray %>% image_threshold("black", "80%")
  image_write(img_bw, paste(path.out, files, sep= "/"))
  return(img_bw)
}
bw_pixelcount <- function(image){
  img_data <- image_data(image)
  # Counting Black Pixels
  black_pixels <- sum(img_data <= 1)  # You can adjust this threshold as necessary
  return(black_pixels)
}

```

## Read in relevant metadata and list files to be worked with

```{r}
drought = read_csv(here("data", "drought_treatments.csv")) %>% 
  rename(drought_treat=treatment)

size_master = read_csv(here("data", "seedling_measurements", "size_master.csv")) %>% 
  mutate(length = case_when(
    !is.na(branching) ~ branching + height_cm,
    .default = height_cm)) %>% 
  left_join(drought) %>% 
  filter(date == "2023-03-01") %>% 
  select(seedling_id, seedling_sp, soil_type)

path.in = here("scans") #where are the raw photos? 
files = list.files(path.in)

img_tib = tibble(files) %>% 
  mutate(seedling_id = as.numeric(str_sub(files, 1,4))) %>% 
  mutate(plant_compartment = str_sub(files, 6,6)) %>%
  left_join(size_master)
```

## Break out samples into manageable sizes for fluidity of computation
Below are a set of repeated workflows for each species x compartment combination. 

```{r, eval = F}
path.out = here("scans_bw", "oak_aboveground") # Where shall we put the edited photos? 

qa_img = img_tib %>% 
  filter(plant_compartment == "A") %>% 
  filter(seedling_sp == "Q") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54)) #300dpi > in^2 > cm^2

qa_img_save = qa_img %>% 
  select(1:5, 8,9)

write_csv(qa_img_save, here("data", "image_processing", "qa_images.csv"))
```

```{r}
path.out = here("scans_bw", "oak_foliar") # Where shall we put the edited photos? 

qf_img = img_tib %>% 
  filter(plant_compartment == "F") %>% 
  filter(seedling_sp == "Q") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54))

qf_img_save = qf_img %>% 
  select(1:5, 8,9)

write_csv(qf_img_save, here("data", "image_processing", "qf_images.csv"))
```

```{r}
path.out = here("scans_bw", "oak_belowground") # Where shall we put the edited photos? 

qb_img = img_tib %>% 
  filter(plant_compartment == "B") %>% 
  filter(seedling_sp == "Q") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54))

qb_img_save = qb_img %>% 
  select(1:5, 8,9)

write_csv(qb_img_save, here("data", "image_processing", "qb_images.csv"))
```

```{r, eval = F}
path.out = here("scans_bw", "fir_aboveground") # Where shall we put the edited photos? 

pa_img = img_tib %>% 
  filter(plant_compartment == "A") %>% 
  filter(seedling_sp == "P") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54))

pa_img_save = pa_img %>% 
  select(1:5, 8,9)

write_csv(pa_img_save, here("data", "image_processing", "pa_images.csv"))
```

```{r}
path.out = here("scans_bw", "fir_foliar") # Where shall we put the edited photos? 


pf_img = img_tib %>% 
  filter(plant_compartment == "F") %>% 
  filter(seedling_sp == "P") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54))

pf_img_save = pf_img %>% 
  select(1:5, 8,9)

write_csv(pf_img_save, here("data", "image_processing", "pf_images.csv"))
```

```{r}
path.out = here("scans_bw", "fir_belowground") # Where shall we put the edited photos? 

pb_img = img_tib %>% 
  filter(plant_compartment == "B") %>% 
  filter(seedling_sp == "P") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54))

pb_img_save = pb_img %>% 
  select(1:5, 8,9)

write_csv(pb_img_save, here("data", "image_processing", "pb_images.csv"))
```

## Repeat the above process for images taken by collaborators working to collect water potentials

```{r}

path.in = here("wp_scans") #where are the raw photos? 
files = list.files(path.in)

img_tib = tibble(files) %>% 
  mutate(seedling_id = as.numeric(str_sub(files, 1,4))) %>% 
  mutate(plant_compartment = str_sub(files, 6,6)) %>%
  left_join(size_master)
```

```{r}
path.out = here("scans_bw", "oak_wp") # Where shall we put the edited photos? 

qw_img = img_tib %>% 
  filter(seedling_sp == "Q") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54)) #300dpi > in^2 > cm^2

qw_img_save = qw_img %>% 
  select(1:5, 8,9)

write_csv(qw_img_save, here("data", "image_processing", "qw_images.csv"))
```

```{r}
path.out = here("scans_bw", "fir_wp") # Where shall we put the edited photos? 

pw_img = img_tib %>% 
  filter(seedling_sp == "P") %>% 
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54)) #300dpi > in^2 > cm^2

pw_img_save = pw_img %>% 
  select(1:5, 8,9)

write_csv(pw_img_save, here("data", "image_processing", "pw_images.csv"))
```


See file image_data.Rmd for a workflow to combine all written csv files into a single dataset. 
```{r}
drought = read_csv(here("data", "drought_treatments.csv")) %>% 
  rename(drought_treat=treatment)

size_master = read_csv(here("data", "seedling_measurements", "size_master.csv")) %>% 
  mutate(length = case_when(
    !is.na(branching) ~ branching + height_cm,
    .default = height_cm)) %>% 
  left_join(drought) %>% 
  filter(date == "2023-03-01") %>% 
  select(seedling_id, seedling_sp, soil_type)

path.in = here("scan_delayed") #where are the raw photos? 
files = list.files(path.in)

img_tib_delay = tibble(files) %>% 
  mutate(seedling_id = as.numeric(str_sub(files, 1,4))) %>% 
  mutate(plant_compartment = str_sub(files, 6,6)) %>%
  left_join(size_master)
```

```{r}
path.out = here("scans_bw", "delayed") # Where shall we put the edited photos? 

delay_img = img_tib_delay %>%  
  mutate(image = map(files, ~ image_read(paste(path.in, .x, sep ="/")))) %>%
  mutate(bw_image = map2(.x=image, .y = files, ~ bw_conversion(.x, .y, path.out))) %>%
  mutate(blk_pixels = map_dbl(bw_image, ~bw_pixelcount(.x))) %>%
  mutate(area = blk_pixels/(300*300*2.54*2.54)) #300dpi > in^2 > cm^2

delay_img_save = delay_img %>% 
  select(1:5, 8,9)

write_csv(delay_img_save, here("data", "image_processing", "delayed_images.csv"))
```

