---
title: "results"
author: "Gabe Runte"
date: "2024-07-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(janitor)
library(RColorBrewer)
# library(ISLR)
library(rpart)
library(rpart.plot)
# library(vip)
library(rattle)
library(dismo)
library(patchwork)
library(tidyverse)

source(here("src", "colors.R"))
```

## Read in files
```{r, message = F}
measure = read_csv(here("data", "analysis/size_master.csv"))
harvest = read_csv(here("data", "analysis/harvest_metrics.csv")) 
health = read_csv(here("data", "analysis/ndvi_data.csv"))
harvest_tips = read_csv(here("data", "analysis/harvest_roottips - all.csv")) %>% 
  filter(!is.na(seedling_id))
repot_tips = read_csv(here("data", "repotting/ghecto_repotting_root_pulling_data.csv"))
harvest_mass = read_csv(here("data", "harvest", "harvest_biomass_wideclean.csv"))
image_data = read_csv(here("data", "wide_final_seedling_area.csv"))
repot_mass = read_csv(here("data", "repotting", "repotting_drymass_fitted.csv"))
neighb_pairs = read_csv(here("data", "design", "ghecto_neighbor_pairs.csv"))
trt = read_csv(here("data", "design", "seedling_treatments.csv"))
drought = read_csv(here("data", "design", "drought_assignments_bypot.csv")) %>% select(1,3)
harvest_comm = read_csv( here("data", "harvest", "harvest_community_matrix_scaled.csv"))

pressure = read_csv(here("data/harvest", "pressure_bomb - Sheet1.csv")) %>% select(1:4) %>%  mutate(time = tolower(time))
sapwood = read_csv(here("data/harvest", "harvest_sapwood.csv"))
```

### Edit/compile some files
```{r, warning = F, message=F}
colonization = repot_tips %>% 
  mutate(repot_col = case_when(
    colonization_numerator == 0 ~ 0,
    .default = colonization_numerator/colonization_denominator)) %>% 
  select(seedling_id, repot_col) %>% 
  left_join(harvest_tips %>% 
              mutate(harvest_col = case_when(
                    colonized == 0 ~ 0,
                    .default =colonized/(colonized+uncolonized))) %>% 
              select(seedling_id, harvest_col) %>% 
              mutate(seedling_id = as.numeric(seedling_id)))

drought_treat = health %>% 
  select(seedling_id, treatment) %>% distinct()

total_treat = measure %>% 
  select(seedling_id, seedling_sp, soil_type, neighbor, neighb_sp, neighb_st, pot) %>% distinct() %>% drop_na() %>% left_join(drought_treat)

sort_string_chars <- function(s) {
  paste(sort(unlist(strsplit(s, ""))), collapse = "")}

pot_df = neighb_pairs %>% 
  rename(seedling_id = seedling_1) %>% 
  left_join(trt) %>% 
  rename(sp1 = seedling_sp, st1 = soil_type) %>% 
  select(!seedling_id) %>% 
  rename(seedling_id = seedling_2) %>% 
  left_join(trt)%>% 
  rename(sp2 = seedling_sp, st2 = soil_type) %>% 
  mutate(spp = paste0(sp1, sp2))%>% 
  mutate(stt = paste0(st1, st2)) %>% 
  select(pot, spp, stt) %>% 
  mutate(spp = map_chr(spp, sort_string_chars)) %>% #alphabetize the combo to minimize different uniques
  mutate(stt = map_chr(stt, sort_string_chars)) %>% 
  left_join(drought)

living = measure %>% 
  filter(date == "2022-04-01") %>% 
  filter(alive ==1)  %>% 
  select(seedling_id)
```


## Mass and relative growth
```{r}
grow_mass = repot_mass %>% 
  rename(r_shoot = above_dry, r_root = below_dry) %>% 
  mutate(r_rs = r_root/r_shoot) %>%
  mutate(r_total = r_root+r_shoot) %>%
  left_join(harvest_mass %>% 
              mutate(shoot = shoot +foliar) %>%  select(-foliar) %>% 
              rename(h_shoot = shoot, h_root = root) %>% 
              mutate(h_rs = h_root/h_shoot)) %>%
              mutate(h_total = h_root+h_shoot)%>% 
  mutate(grow_root = (h_root-r_root)/r_root)%>% 
  mutate(grow_shoot = (h_shoot-r_shoot)/r_shoot) %>% 
  mutate(grow_rs = log(h_rs/r_rs)) %>% 
  mutate(grow_total = ((h_total-r_total)/r_total)) %>%
  mutate(soil_type = fct_relevel(soil_type, c("P", "Q", "C"))) %>% 
  left_join(drought_treat) %>% 
  left_join(total_treat) %>% 
  left_join(repot_mass %>% 
              mutate(n_total = above_dry+below_dry) %>% 
              select(seedling_id, n_total) %>%  rename(neighbor = seedling_id)) %>% 
  mutate(n_rel = r_total^2/n_total) %>% 
  filter(seedling_id %in% living$seedling_id)

grow_mass_all = repot_mass %>% 
  rename(r_shoot = above_dry, r_root = below_dry) %>% 
  mutate(r_rs = r_root/r_shoot) %>%
  mutate(r_total = r_root+r_shoot) %>%
  left_join(harvest_mass %>% 
              mutate(shoot = shoot +foliar) %>%  select(-foliar) %>% 
              rename(h_shoot = shoot, h_root = root) %>% 
              mutate(h_rs = h_root/h_shoot)) %>%
              mutate(h_total = h_root+h_shoot)%>% 
  mutate(grow_root = (h_root-r_root)/r_root)%>% 
  mutate(grow_shoot = (h_shoot-r_shoot)/r_shoot) %>% 
  mutate(grow_rs = log(h_rs/r_rs)) %>% 
  mutate(grow_total = ((h_total-r_total)/r_total)) %>%
  mutate(soil_type = fct_relevel(soil_type, c("P", "Q", "C"))) %>% 
  left_join(drought_treat) %>% 
  left_join(total_treat) %>% 
  left_join(repot_mass %>% 
              mutate(n_total = above_dry+below_dry) %>% 
              select(seedling_id, n_total) %>%  rename(neighbor = seedling_id)) %>% 
  mutate(n_rel = r_total^2/n_total)

rel_size = grow_mass %>% 
  select(seedling_id, r_total) %>% 
  left_join(total_treat) %>% 
  group_by(seedling_sp, soil_type) %>% 
  mutate(avg_mass = (r_total-mean(r_total, na.rm = T))/sd(r_total, na.rm = T)) %>% 
  ungroup() %>% 
  select(seedling_id, avg_mass) %>% 
  rename(rel_mass = avg_mass)

rel_final = grow_mass %>% 
  select(seedling_id, h_total) %>% 
  left_join(total_treat) %>% 
  group_by(seedling_sp, soil_type, neighb_sp, neighb_st) %>% 
  mutate(avg_mass = (h_total-mean(h_total, na.rm = T))/sd(h_total, na.rm = T)) %>% 
  ungroup() %>% 
  select(seedling_id, avg_mass) %>% 
  rename(rel_hmass = avg_mass)

n_relsize = rel_size %>% 
  rename(neighbor = seedling_id, n_relmass = rel_mass)


rel_set = rel_size %>% 
  left_join(rel_final) %>% 
  left_join(total_treat) %>% 
  left_join(n_relsize) %>% 
  left_join(drought_treat) %>% 
  left_join(grow_mass) %>% 
  mutate(rel = rel_mass-n_relmass) 

ndvi = health %>% 
  group_by(seedling_id) %>% 
  summarize(ndvi = mean(mean_ndvi)) %>% 
  left_join(total_treat)%>% 
  mutate(home_rank = case_when(
    soil_type == seedling_sp & neighb_sp == soil_type & soil_type==neighb_st ~ "Both",
    soil_type == seedling_sp ~ "Self",
    seedling_sp == neighb_st ~ "Neighbor",
    .default = "None"
  )) %>% 
  mutate(home_rank = factor(home_rank, levels = c("None", "Neighbor", "Self", "Both"))) %>% 
  filter(!is.na(seedling_sp)) %>% 
  filter(seedling_id %in% living$seedling_id)
```

### Decision tree example (basic)
```{r}


#build the initial decision tree
tree <- rpart(ndvi ~ soil_type+neighb_sp+neighb_st+treatment, data=ndvi %>%
                filter(seedling_sp == "P"), control=rpart.control(cp=.0001))

#identify best cp value to use
best <- tree$cptable[which.min(tree$cptable[,"xerror"]),"CP"]

#produce a pruned tree based on the best cp value
pruned_tree <- prune(tree, cp=best)

#plot the pruned tree
prp(pruned_tree)

prp(pruned_tree,
    faclen=0, #use full names for factor labels
    extra=1, #display number of observations for each terminal node
    roundint=T, #don't round to integers in output
    digits=2) #display 5 decimal places in output
```


```{r}
data.length = nrow(grow_mass %>%filter(seedling_sp == "P"))
tree_model <- rpart(ndvi ~ soil_type+neighb_sp+neighb_st+treatment, data=ndvi %>%
                filter(seedling_sp == "P"), method = "anova",  
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0))

best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]

#produce a pruned tree based on the best cp value
pruned_tree <- prune(tree_model, cp=best)

# Plot the decision tree
rpart.plot(pruned_tree, box.palette = "Blues",yesno=2,extra=1,)

# Create a variable importance plot
var_importance <- vip::vip(tree_model, num_features = 10)
print(var_importance)
```

### Bigcone biomass decision tree
```{r}
data.length = nrow(grow_mass_all %>%filter(seedling_sp == "P"))


tree_dataset=grow_mass_all %>%
                filter(seedling_sp == "P") %>% 
  select(h_total,h_shoot,h_root,soil_type,neighb_sp,neighb_st,treatment) %>% 
  rename("SoilType" =soil_type, NeighborSoil = neighb_st, Drought = treatment, NeighborSpecies = neighb_sp) %>% 
  mutate(Drought = case_when(Drought=="D"~"Yes", .default = "No"))%>% 
  mutate(SoilType = case_when(SoilType=="C"~"Sterile", SoilType=="Q"~"Oak",SoilType=="P"~"Bigcone"))%>% 
  mutate(NeighborSoil = case_when(NeighborSoil=="C"~"Sterile", NeighborSoil=="Q"~"Oak",NeighborSoil=="P"~"Bigcone"))%>% 
  mutate(NeighborSpecies = case_when(NeighborSpecies=="Q"~"Oak",NeighborSpecies=="P"~"Bigcone")) %>% 
  mutate(rs = h_root/h_shoot)


data.length = nrow(tree_dataset)

tree_model <- rpart(h_shoot ~ SoilType+NeighborSpecies+NeighborSoil+Drought, data=tree_dataset, method = "anova", 
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0.01))
best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
pruned_tree <- prune(tree_model, cp=best)
fancyRpartPlot(tree_model,yesno=2,
               main = "Bigcone shoot biomass",type = 2,
               caption="",palette="Greens")

var_importance <- vip::vip(tree_model, num_features = 4, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))
var_importance+theme_minimal()

data.length = nrow(tree_dataset)

png(here("figures", "bigcone_total_tree.png"), bg= "transparent", width = 500, height = 500, res = 300,units = "px", pointsize = 5)
tree_model <- rpart(h_total ~ SoilType+NeighborSpecies+NeighborSoil+Drought, data=tree_dataset, method = "anova", 
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0.01))
best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
pruned_tree <- prune(tree_model, cp=best)
fancyRpartPlot(tree_model,yesno=2,
               main = "Bigcone total biomass",type = 2,
               caption="",palette="Greens")
dev.off()

var_importance <- vip::vip(tree_model, num_features = 4, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))
var_importance+theme_minimal()

png(here("figures", "bigcone_ndvi_tree.png"), bg= "transparent", width = 500, height = 500, res = 300,units = "px", pointsize = 5)
tree_model <- rpart(ndvi ~ soil_type+neighb_sp+neighb_st+treatment, data=ndvi %>% filter(seedling_sp == "P"), method = "anova", 
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0.01))
best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
pruned_tree <- prune(tree_model, cp=best)
fancyRpartPlot(tree_model,yesno=2,
               main = "Bigcone NDVI",type = 2,
               caption="",palette="Greens")
dev.off()

var_importance <- vip::vip(tree_model, num_features = 4, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))
var_importance+theme_minimal()
```


### Oak biomass decision tree
```{r}
data.length = nrow(grow_mass_all %>%filter(seedling_sp == "Q"))


tree_dataset=grow_mass_all %>%
                filter(seedling_sp == "Q") %>% 
  select(h_total,h_shoot,soil_type,neighb_sp,neighb_st,treatment) %>% 
  rename("SoilType" =soil_type, NeighborSoil = neighb_st, Drought = treatment, NeighborSpecies = neighb_sp) %>% 
  mutate(Drought = case_when(Drought=="D"~"Yes", .default = "No"))%>% 
  mutate(SoilType = case_when(SoilType=="C"~"Sterile", SoilType=="Q"~"Oak",SoilType=="P"~"Bigcone"))%>% 
  mutate(NeighborSoil = case_when(NeighborSoil=="C"~"Sterile", NeighborSoil=="Q"~"Oak",NeighborSoil=="P"~"Bigcone"))%>% 
  mutate(NeighborSpecies = case_when(NeighborSpecies=="Q"~"Oak",NeighborSpecies=="P"~"Bigcone"))


data.length = nrow(tree_dataset)

tree_model <- rpart(h_shoot ~ SoilType+NeighborSpecies+NeighborSoil+Drought, data=tree_dataset, method = "anova", 
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0.01))
best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
pruned_tree <- prune(tree_model, cp=best)
fancyRpartPlot(tree_model,yesno=2,
               main = "Oak shoot biomass",type = 2,
               caption="",palette="Greens")

var_importance <- vip::vip(tree_model, num_features = 4, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))
var_importance+theme_minimal()

data.length = nrow(tree_dataset)

png(here("figures", "oak_total_tree.png"), bg= "transparent", width = 500, height = 500, res = 300,units = "px", pointsize = 5)
tree_model <- rpart(h_total ~ SoilType+NeighborSpecies+NeighborSoil+Drought, data=tree_dataset, method = "anova", 
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0.01))
best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
pruned_tree <- prune(tree_model, cp=best)
fancyRpartPlot(tree_model,yesno=2,
               main = "Oak total biomass",type = 2,
               caption="",palette="Greens")
dev.off()

var_importance <- vip::vip(tree_model, num_features = 4, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))
var_importance+theme_minimal()

png(here("figures", "oak_ndvi_tree.png"), bg= "transparent", width = 500, height = 500, res = 300,units = "px", pointsize = 5)
tree_model <- rpart(ndvi ~ soil_type+neighb_sp+neighb_st+treatment, data=ndvi %>% filter(seedling_sp == "Q"), method = "anova", 
                 control = rpart.control(xval = data.length, minsplit = 2, minbucket = 1, cp = 0.01))
best <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
pruned_tree <- prune(tree_model, cp=best)
fancyRpartPlot(tree_model,yesno=2,
               main = "Oak NDVI",type = 2,
               caption="",palette="Greens")
dev.off()


var_importance <- vip::vip(tree_model, num_features = 4, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))
var_importance+theme_minimal()
```

### Saving a decision tree figure
```{r}

png(here("figures", "bigcone_decision.png"), bg= "transparent", width = 700, height = 500, res = 300,units = "px", pointsize = 5)
    
rpart.plot(tree_model, # middle graph
extra = 1, # show fitted class, probs, percentages
box.palette = "-BuRd", # color scheme
branch.lty = 1, # dotted branch lines
shadow.col = NA, # shadows under the node boxes
nn = TRUE) # display the node numbers

dev.off()


# Plot the decision tree
rpart.plot(pruned_tree, box.palette = "Blues",yesno=2,extra=1,)
var_importance <- vip::vip(tree_model, num_features = 10, horizontal = F,
    aesthetics = list(fill = "darkgray", alpha = 0.75))

var_importance+theme_minimal()


```




## Survival figures 
```{r}
surviving = measure %>% 
  filter(date == "2023-03-01") %>% 
  left_join(drought_treat) %>% 
  mutate(home_rank = case_when(
    soil_type == seedling_sp  & soil_type==neighb_st ~ "Both",
    soil_type == "C" & soil_type==neighb_st ~ "Sterile",
    soil_type == seedling_sp ~ "Self",
    seedling_sp == neighb_st ~ "Neighbor",
    .default = "None"
  ))%>% 
  mutate(home_rank = factor(home_rank, levels = c("Sterile", "None", "Neighbor", "Self", "Both"))) %>% 
  group_by(seedling_sp, home_rank, treatment, alive) %>% 
  summarize(count =n())

surv_wide = surviving %>% pivot_wider(names_from = alive, values_from = count, names_prefix = "alive_") %>% 
  mutate(alive_1 = case_when(is.na(alive_1) ~0, .default = alive_1)) %>% 
  mutate(alive_0 = case_when(is.na(alive_0) ~0, .default = alive_0))%>% 
  mutate(survival = alive_1/(alive_0+alive_1)) 
  

ggplot(surv_wide, aes(x = home_rank, y = survival, fill = treatment))+
  geom_bar(stat = "identity", position = position_dodge())+facet_wrap(~seedling_sp)+gg_droughtfill


all_trt = grow_mass_all%>% 
  mutate(home_rank = case_when(
    soil_type == seedling_sp  & soil_type==neighb_st ~ "Both",
    soil_type == "C" & soil_type==neighb_st ~ "Sterile",
    soil_type == seedling_sp ~ "Self",
    seedling_sp == neighb_st ~ "Neighbor",
    .default = "None"
  ))%>% 
  mutate(home_rank = factor(home_rank, levels = c("Sterile", "None", "Neighbor", "Self", "Both")))

ggplot(all_trt, aes(x = home_rank, y = h_total, fill = treatment))+
  geom_boxplot(outlier.shape = NA)+facet_wrap(~seedling_sp, scales = "free")+gg_droughtfill

ggplot(all_trt, aes(x = home_rank, y = h_shoot, fill = treatment))+
  geom_boxplot(outlier.shape = NA)+facet_grid(rows = vars(seedling_sp), cols = vars(neighb_sp), scales = "free")+gg_droughtfill

ggplot(all_trt, aes(x = home_rank, y = h_shoot, fill = neighb_sp))+
  geom_boxplot(outlier.shape = NA)+facet_grid(rows = vars(seedling_sp), cols = vars(treatment), scales = "free")
```

```{r}
surviving = measure %>% 
  filter(date == "2023-03-01") %>% 
  left_join(drought_treat) %>% 
  mutate(home_rank = case_when(
    soil_type == seedling_sp  & soil_type==neighb_st ~ "Both",
    soil_type == "C" & soil_type==neighb_st ~ "Sterile",
    soil_type == seedling_sp ~ "Self",
    seedling_sp == neighb_st ~ "Neighbor",
    .default = "None"
  ))%>% 
  mutate(home_rank = factor(home_rank, levels = c("Sterile", "None", "Neighbor", "Self", "Both"))) %>% 
  group_by(seedling_sp, home_rank, treatment, alive, neighb_sp) %>% 
  summarize(count =n())%>% 
  mutate(nsp_long = case_when(
  neighb_sp == "P"~ "n. Bigcone",
  neighb_sp == "Q"~ "n. Oak"
  ))

surv_wide = surviving %>% pivot_wider(names_from = alive, values_from = count, names_prefix = "alive_") %>% 
  mutate(alive_1 = case_when(is.na(alive_1) ~0, .default = alive_1)) %>% 
  mutate(alive_0 = case_when(is.na(alive_0) ~0, .default = alive_0)) %>% 
  mutate(survival = alive_1/(alive_0+alive_1)) 
  

ggplot(surv_wide, aes(x = home_rank, y = survival, fill = treatment))+
  geom_bar(stat = "identity", position = position_dodge())+facet_wrap(seedling_sp~nsp_long)+gg_droughtfill
```

## Begin `gbm()` work

```{r}

gbm_data = grow_mass_all %>%filter(seedling_sp == "P") %>% 
  dplyr::select(h_total, soil_type, neighb_sp, neighb_st, treatment) %>% 
  drop_na() %>% 
  mutate(h_total = as.numeric(h_total)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))


gbm_model = gbm.step(data = data.frame(gbm_data), gbm.x = 2:5, gbm.y = 1, family = "gaussian", tree.complexity = 5,
         learning.rate = 0.0005, bag.fraction = 0.5, step.size = 25)
names(gbm_model)
gbm_model$interaction.depth
summary(gbm_model)
gbm_model$self.statistics
gbm_model$cv.statistics
```



## Testing a range of `gbm()` parameters
```{r, eval = F}
gbm_data_ptot = grow_mass_all %>%filter(seedling_sp == "P") %>% 
  dplyr::select(h_total, soil_type, neighb_sp, neighb_st, treatment) %>% 
  drop_na() %>% 
  mutate(h_total = as.numeric(h_total)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))

tc_set = seq(1,3, length.out = 3) ##lower has lower r2 but higher deviance explained and higher cv-corr
lr_set = seq(0.001, 0.0001, length.out = 3) ##no strong effect observed...
bg_set = seq(0.5, 0.75, , length.out = 3) ##not a strong effect. landing on accepted range from Elith et al 2008

gbm_set_ptot = tibble(expand_grid(tc_set, lr_set, bg_set)) %>% 
  mutate(cv_corr = 0)%>% 
  mutate(r2 = 0)%>% 
  mutate(dev_exp = 0)%>% 
  mutate(seedling_sp = "P")%>% 
  mutate(compartment = "total")

for(i in 1:length(gbm_set$bg_set)){
  gbm_model_holding = gbm.step(data = data.frame(gbm_data_ptot), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = gbm_set_ptot$lr_set[i], bag.fraction = gbm_set_ptot$bg_set[i], tree.complexity = gbm_set_ptot$tc_set[i]
  )
  gbm_set_ptot$cv_corr[i] <- gbm_model_holding$cv.statistics$correlation.mean
  gbm_set_ptot$r2[i] <- gbm_model_holding$self.statistics$correlation
  gbm_set_ptot$dev_exp[i] <- (gbm_model_holding$self.statistics$mean.null-gbm_model_holding$cv.statistics$deviance.mean)/gbm_model_holding$self.statistics$mean.null

}
```

Plots for choosing model parameter values/ranges
```{r, eval = F}
ggplot(gbm_set_ptot, aes(x = as.factor(tc_set), y = r2))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(lr_set), y = r2))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(bg_set), y = r2))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(tc_set), y = dev_exp))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(lr_set), y = dev_exp))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(bg_set), y = dev_exp))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(tc_set), y = cv_corr))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(lr_set), y = cv_corr))+
  geom_boxplot()
ggplot(gbm_set_ptot, aes(x = as.factor(bg_set), y = cv_corr))+
  geom_boxplot()
```

### Best model parameters
best model for total P biomass 
tc = 2
bag = 0.6
lr = 0.0005


## Best models
```{r}
gbm_data_ptot = grow_mass_all %>%filter(seedling_sp == "P") %>% 
  dplyr::select(h_total, soil_type, neighb_sp, neighb_st, treatment) %>% 
  drop_na() %>% 
  mutate(h_total = as.numeric(h_total)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))

best_p_total =  gbm.step(data = data.frame(gbm_data_ptot), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = 0.0005, bag.fraction = 0.6, tree.complexity = 2)

gbm.plot(best_p_total)
interactions = gbm.interactions(best_p_total)

# Find interactions in the gbm model:
find.int <- gbm.interactions( best_p_total)
find.int$interactions
find.int$rank.list
interactions$gbm.call

interactions$interactions



best_p_total$cv.statistics$deviance.mean
```

```{r}
gbm_data_ptot = grow_mass_all %>%filter(seedling_sp == "P") %>% 
  dplyr::select(h_total, soil_type, neighb_sp, neighb_st, treatment) %>% 
  left_join(colonization %>% select(1:2))
  drop_na() %>% 
  mutate(h_total = as.numeric(h_total)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))

best_p_total =  gbm.step(data = data.frame(gbm_data_ptot), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = 0.0005, bag.fraction = 0.6, tree.complexity = 2)

gbm.plot(best_p_total)
interactions = gbm.interactions(best_p_total)

# Find interactions in the gbm model:
find.int <- gbm.interactions( best_p_total)
find.int$interactions
find.int$rank.list
interactions$gbm.call

interactions$interactions



best_p_total$cv.statistics$deviance.mean
```

```{r}
best_p_total =  gbm.step(data = data.frame(gbm_data_ptot), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = 0.0005, bag.fraction = 0.6, tree.complexity = 2)

gbm.plot(best_p_total)
interactions = gbm.interactions(best_p_total)

best_inf = tibble(best_p_total$contributions) %>% 
  mutate(var = fct_reorder(var, rel.inf))

ggplot(best_inf, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+
  scale_fill_continuous(name = "Relative \nInfluence")+theme_minimal()

pbest_plot = best_inf %>% 
  mutate(var = case_when(
    var== "soil_type" ~ "Soil type",
    var== "neighb_st" ~ "Neighbor soil",
    var== "treatment" ~ "Drought",
    var== "neighb_sp" ~ "Neighbor species"
  )) %>% 
  mutate(var = fct_reorder(var, rel.inf))

p_relinf = ggplot(pbest_plot, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+ 
  scale_fill_viridis_c(name = "Relative \nInfluence",direction = -1, option = "turbo")+theme_minimal()

p_relinf = ggplot(pbest_plot, aes(x = var, y = rel.inf))+
  geom_bar(stat= "identity", fill = "#5A745B", alpha = 0.75)+labs(x = "Predictor", y="Relative Influence")+theme_minimal()

cowplot::save_plot(plot = p_relinf, 
  base_height = 5,
  base_asp = 1,filename =  here("figures", "bigcone_relative_inf.jpg"))
```

## Plotting

```{r}
best_st <- tibble(gbm::plot.gbm(best_p_total, i.var = 1, return.grid = TRUE)) %>%
  mutate(st_long = case_when(
    soil_type == "P" ~ "Bigcone",
    soil_type == "Q" ~ "Oak",
    soil_type == "C" ~ "Sterile"
  ))
best_nsp <- tibble(gbm::plot.gbm(best_p_total, i.var = 2, return.grid = TRUE))%>% 
  mutate(nsp_long = case_when(
    neighb_sp == "P" ~ "Bigcone",
    neighb_sp == "Q" ~ "Oak"
  ))
best_nst <- tibble(gbm::plot.gbm(best_p_total, i.var =3, return.grid = TRUE))%>% 
  mutate(nst_long = case_when(
    neighb_st == "P" ~ "Bigcone ",
    neighb_st == "Q" ~ "Oak",
    neighb_st == "C" ~ "Sterile"
  ))
best_trt <- tibble(gbm::plot.gbm(best_p_total, i.var =4, return.grid = TRUE))%>% 
  mutate(trt_long = case_when(
    treatment == "D" ~ "Drought",
    treatment == "C" ~ "Watered"
  ))




bst_plot = ggplot(best_st, aes(x = st_long, y = y, fill = soil_type))+
  geom_bar(stat="identity")+
  labs(x = "Soil type", y = "Predicted mass")+gg_soilfill+theme_minimal()+
  theme(legend.position = "none")

bnsp_plot = ggplot(best_nsp, aes(x = nsp_long, y = y, fill = neighb_sp))+
  geom_bar(stat="identity")+
  labs(x = "Neighbor species", y = "Predicted mass")+gg_nspfill+theme_minimal()+
  theme(legend.position = "none")

bnst_plot = ggplot(best_nst, aes(x = nst_long, y = y, fill = neighb_st))+
  geom_bar(stat="identity")+
  labs(x = "Neighbor soil type", y = "Predicted mass")+gg_nsoilfill+theme_minimal()+
  theme(legend.position = "none")

btrt_plot = ggplot(best_trt, aes(x = trt_long, y = y, fill = treatment))+
  geom_bar(stat="identity")+
  labs(x = "Watering treatment", y = "Predicted mass")+gg_droughtfill+theme_minimal()+
  theme(legend.position = "none")

gridplot = (bst_plot+btrt_plot)/(bnsp_plot+bnst_plot)


cowplot::save_plot(plot = gridplot, 
  base_height = 5,
  base_asp = 1,filename =  here("figures", "bigcone_predict.jpg"))
```

```{r}


simple_set = gbm_data_ptot %>% 
  group_by(soil_type,neighb_st) %>% 
  summarize(n = n()) %>% 
  select(-n) %>% mutate(neighb_sp = "P") %>% mutate(treatment = "D")

pred_mass = gbm::predict.gbm(best_p_total, simple_set)

pred_set = simple_set %>% 
  ungroup() %>% 
  mutate(h_total = pred_mass)%>%
  mutate(st_long = case_when(
    soil_type == "P" ~ "Bigcone",
    soil_type == "Q" ~ "Oak",
    soil_type == "C" ~ "Sterile"
  ))%>% 
  mutate(nst_long = case_when(
    neighb_st == "P" ~ "Bigcone ",
    neighb_st == "Q" ~ "Oak",
    neighb_st == "C" ~ "Sterile"
  ))

pred_biomass_pplot = ggplot(pred_set, aes(x = st_long, y = nst_long, fill = h_total))+
  geom_tile()+
  scale_fill_distiller(palette = "Greens", direction = 1, name = "Predicted\nbiomass") +
  theme_minimal()+labs( x = "Soil type", y = "Neighbor soil type")

cowplot::save_plot(plot = pred_biomass_pplot, 
  base_height = 5,
  base_asp = 1.2,filename =  here("figures", "bigcone_predict_biomass.jpg"))

cowplot::save_plot(plot = pred_biomass_pplot, 
  base_height = 4,
  base_asp = 1.2,filename =  here("figures", "bigcone_predict_biomass_big.jpg"))
```

```{r}

gbm_data_pndvi = grow_mass_all %>%filter(seedling_sp == "P") %>% 
  left_join(ndvi %>% select(1:2)) %>% 
  dplyr::select(ndvi, soil_type, neighb_sp, neighb_st, treatment) %>% 
  drop_na() %>% 
  mutate(ndvi = as.numeric(ndvi)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))


best_p_ndvi =  gbm.step(data = data.frame(gbm_data_pndvi), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = 0.0005, bag.fraction = 0.6, tree.complexity = 2)

interactions = gbm.interactions(best_p_ndvi)

best_inf_pndvi = tibble(best_p_ndvi$contributions) %>% 
  mutate(var = fct_reorder(var, rel.inf))

ggplot(best_inf_pndvi, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+
  scale_fill_continuous(name = "Relative \nInfluence")+theme_minimal()

pbest_plot_ndvi = best_inf_pndvi %>% 
  mutate(var = case_when(
    var== "soil_type" ~ "Soil type",
    var== "neighb_st" ~ "Neighbor soil",
    var== "treatment" ~ "Drought",
    var== "neighb_sp" ~ "Neighbor species"
  )) %>% 
  mutate(var = fct_reorder(var, rel.inf))

p_relinf_ndvi = ggplot(pbest_plot_ndvi, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+ 
  scale_fill_viridis_c(name = "Relative \nInfluence",direction = -1, option = "turbo")+theme_minimal()

p_relinf_ndvi = ggplot(pbest_plot_ndvi, aes(x = var, y = rel.inf))+
  geom_bar(stat= "identity", fill = "#5A745B", alpha = 0.75)+labs(x = "Predictor", y="Relative Influence")+theme_minimal()

cowplot::save_plot(plot = p_relinf_ndvi,
  base_height = 5,
  base_asp = 1,filename =  here("figures", "bigcone_relative_inf_ndvi.jpg"))

cowplot::save_plot(plot = p_relinf_ndvi,
  base_height = 4,
  base_asp = 1,filename =  here("figures", "bigcone_relative_inf_ndvi_big.jpg"))
```


```{r}

gbm_data_qtot = grow_mass_all %>%filter(seedling_sp == "Q") %>% 
  dplyr::select(h_total, soil_type, neighb_sp, neighb_st, treatment) %>% 
  drop_na() %>% 
  mutate(h_total = as.numeric(h_total)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))


best_q_total =  gbm.step(data = data.frame(gbm_data_qtot), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = 0.0005, bag.fraction = 0.6, tree.complexity = 2)

interactions = gbm.interactions(best_q_total)

best_inf_q = tibble(best_q_total$contributions) %>% 
  mutate(var = fct_reorder(var, rel.inf))

ggplot(best_inf_q, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+
  scale_fill_continuous(name = "Relative \nInfluence")+theme_minimal()

qbest_plot = best_inf_q %>% 
  mutate(var = case_when(
    var== "soil_type" ~ "Soil type",
    var== "neighb_st" ~ "Neighbor soil",
    var== "treatment" ~ "Drought",
    var== "neighb_sp" ~ "Neighbor species"
  )) %>% 
  mutate(var = fct_reorder(var, rel.inf))

q_relinf = ggplot(qbest_plot, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+ 
  scale_fill_viridis_c(name = "Relative \nInfluence",direction = -1, option = "turbo")+theme_minimal()

q_relinf = ggplot(qbest_plot, aes(x = var, y = rel.inf))+
  geom_bar(stat= "identity", fill = "#A46F00", alpha = 0.75)+labs(x = "Predictor", y="Relative Influence")+theme_minimal()

cowplot::save_plot(plot = q_relinf, 
  base_height = 5,
  base_asp = 1,filename =  here("figures", "oak_relative_inf.jpg"))
```

```{r}

gbm_data_qndvi = grow_mass_all %>%filter(seedling_sp == "Q") %>% 
  left_join(ndvi %>% select(1:2)) %>% 
  dplyr::select(ndvi, soil_type, neighb_sp, neighb_st, treatment) %>% 
  drop_na() %>% 
  mutate(ndvi = as.numeric(ndvi)) %>% 
  mutate(soil_type = as.factor(soil_type))%>% 
  mutate(neighb_sp = as.factor(neighb_sp))%>% 
  mutate(neighb_st = as.factor(neighb_st))%>% 
  mutate(treatment = as.factor(treatment))


best_q_ndvi =  gbm.step(data = data.frame(gbm_data_qndvi), gbm.x = 2:5, gbm.y = 1, family = "gaussian", step.size = 25,
                               learning.rate = 0.0005, bag.fraction = 0.6, tree.complexity = 2)

interactions = gbm.interactions(best_q_ndvi)

best_inf_qndvi = tibble(best_q_ndvi$contributions) %>% 
  mutate(var = fct_reorder(var, rel.inf))

ggplot(best_inf_qndvi, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+
  scale_fill_continuous(name = "Relative \nInfluence")+theme_minimal()

qbest_plot_ndvi = best_inf_qndvi %>% 
  mutate(var = case_when(
    var== "soil_type" ~ "Soil type",
    var== "neighb_st" ~ "Neighbor soil",
    var== "treatment" ~ "Drought",
    var== "neighb_sp" ~ "Neighbor species"
  )) %>% 
  mutate(var = fct_reorder(var, rel.inf))

q_relinf_ndvi = ggplot(qbest_plot_ndvi, aes(x = var, y = rel.inf, fill = rel.inf))+
  geom_bar(stat= "identity")+labs(x = "Predictor", y="Relative Influence")+ 
  scale_fill_viridis_c(name = "Relative \nInfluence",direction = -1, option = "turbo")+theme_minimal()

q_relinf_ndvi = ggplot(qbest_plot_ndvi, aes(x = var, y = rel.inf))+
  geom_bar(stat= "identity", fill = "#A46F00", alpha = 0.75)+labs(x = "Predictor", y="Relative Influence")+theme_minimal()

cowplot::save_plot(plot = q_relinf_ndvi,
  base_height = 5,
  base_asp = 1,filename =  here("figures", "oak_relative_inf_ndvi.jpg"))
```

```{r}
oak_prediction = qbest_plot_ndvi %>% 
  mutate(Outcome = "NDVI") %>% 
  bind_rows(qbest_plot %>% mutate(Outcome = "Biomass"))

q_cominf_ndvi = ggplot(oak_prediction, aes(x = var, y = rel.inf, fill = Outcome))+
  geom_bar(stat= "identity",  alpha = 0.75, position= "dodge")+
  labs(x = "Predictor", y="Relative Influence")+theme_minimal()+
  scale_fill_manual(values = c("#A46F00", "darkgray"))

cowplot::save_plot(plot = q_cominf_ndvi,
  base_height = 5,
  base_asp = 2,filename =  here("figures", "oak_combined_inf.jpg"))

cowplot::save_plot(plot = q_cominf_ndvi,
  base_height = 4,
  base_asp = 2,filename =  here("figures", "oak_combined_inf_big.jpg"))
```


